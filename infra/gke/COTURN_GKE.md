# Coturn on GKE deployment

# Create firewall rule

1. Create a firewall rule to allow traffic to the coturn nodes.

```bash
gcloud compute firewall-rules create allow-turn \
    --project ${PROJECT_ID?} \
    --network ${NETWORK_NAME?} \
    --allow tcp:3478,tcp:25000-25100,udp:3478,udp:25000-25100
```

# Deploy manifests

The K8S manifest kustomization requires a K8S Secret named `turn-shared-secret`.

This secret is generated by the kustomization and read from 2 files:

- `TURN_SHARED_SECRET`: Contains the shared secret used by coturn and apps like coturn-web or directly by the selkies-gstreamer python app.
- `TURN_REALM`: contains the domain that the coturn service is hosted under.

1. Create a TURN_SHARED_SECRET and TURN_REALM file used by the kustomization:

```bash
openssl rand -base64 15 > manifests/coturn/TURN_SHARED_SECRET
```

```bash
echo -n "${CLUSTER?}.endpoints.${PROJECT_ID?}.cloud.goog" > manifests/coturn/TURN_REALM
```

2. Apply the manifests using the kustomization:

```bash
kubectl apply -k manifests/coturn
```

3. Verify the deployment by visiting the `/turn/` route:

```bash
echo "https://${CLUSTER?}.endpoints.${PROJECT_ID?}.cloud.goog/turn/"
```

Example output:

```json
{
  "lifetimeDuration": "86400s",
  "iceServers": [
    {
      "urls": [
        "stun:xx.xxx.xxx.xx:3478"
      ]
    },
    {
      "urls": [
        "turn:xx.xxx.xxx.xx:3478?transport=udp"
      ],
      "username": "1642106590-user@example.com",
      "credential": "hHqE7YmBUpvVrIrYOeUQQ/VcP4k="
    }
  ],
  "blockStatus": "NOT_BLOCKED",
  "iceTransportPolicy": "all"
}
```

> NOTE: The `iceServers` list should contain all of the external IPs of the nodes that the coturn pods are running on.
> If you have 2 coturn pods, you should have 2 servers listed.